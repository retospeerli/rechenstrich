<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rechenstrich als Aufgabe ‚Äì Generator</title>
<style>
  :root{
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#eef2f7;
  }
  body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
  .app{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:18px;max-width:1020px;width:100%;box-sizing:border-box;}
  h1{margin:0 0 6px;text-align:center;font-size:1.55rem;}
  .subtitle{margin:0 0 14px;text-align:center;color:#475569;font-size:.98rem;line-height:1.35rem;}
  .hidden{display:none;}

  /* Startmen√º */
  .menu{
    display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-top:16px;
  }
  .bigbtn{
    border:none;cursor:pointer;
    background:#2563eb;color:#fff;
    font-weight:900;font-size:1.25rem;
    padding:16px 26px;border-radius:14px;
    box-shadow:0 10px 20px rgba(37,99,235,.25);
  }
  .bigbtn:hover{background:#1d4ed8;}

  /* Task header */
  .toprow{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;
    margin:8px 0 12px;
  }
  .pill{
    border:1px solid #cbd5e1;border-radius:999px;padding:.35rem .8rem;
    background:#f8fafc;color:#0f172a;font-weight:800;
  }
  .btn{
    border:none;cursor:pointer;border-radius:12px;
    padding:.65rem 1rem;font-weight:900;font-size:1rem;
  }
  .btn.primary{background:#2563eb;color:#fff;}
  .btn.primary:hover{background:#1d4ed8;}
  .btn.secondary{background:#e5e7eb;color:#111827;}
  .btn.secondary:hover{background:#d1d5db;}
  .btn:disabled{background:#94a3b8;color:#fff;cursor:not-allowed;}

  .board{
    background:#f6f6f6;
    border:3px solid #9aa3ad;
    border-radius:14px;
    padding:14px;
  }
  .eq{
    font-size:52px;
    text-align:center;
    font-weight:500;
    letter-spacing:1px;
    margin:8px 0 8px;
  }
  .line{
    height:4px;background:#222;opacity:.65;margin:0 auto 10px;max-width:640px;border-radius:999px;
  }
  svg{width:100%;height:auto;display:block;}

  .actions{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:12px;}
  .feedback{min-height:1.4rem;text-align:center;font-weight:900;margin-top:10px;}
  .ok{color:#15803d;}
  .err{color:#b91c1c;}
  .hint{margin-top:8px;text-align:center;color:#64748b;font-size:.92rem;}
</style>
</head>
<body>
<div class="app">

  <!-- START -->
  <div id="startScreen">
    <h1>Rechenstrich als Aufgabe</h1>
    <p class="subtitle">
      Nur die <b>Startzahl</b> ist schon da.<br>
      <b>Spr√ºnge</b> (H/Z/E), <b>Zwischenresultate</b> und das <b>Endergebnis</b> tr√§gst du ein.<br>
      Erst wenn alles ausgef√ºllt ist, kannst du auf <b>√úberpr√ºfen</b> klicken.
    </p>
    <div class="menu">
      <button class="bigbtn" type="button" onclick="startWithZR(100)">ZR 100</button>
      <button class="bigbtn" type="button" onclick="startWithZR(1000)">ZR 1000</button>
    </div>
  </div>

  <!-- TASK -->
  <div id="taskScreen" class="hidden">
    <div class="toprow">
      <span class="pill" id="zrPill">ZR ?</span>
      <span class="pill" id="modePill">‚Äî</span>
      <span class="pill" id="progressPill">0 / 20</span>
      <button class="btn secondary" type="button" onclick="newTask()">Neue Aufgabe</button>
      <button class="btn secondary" type="button" onclick="backToMenu()">Zur√ºck</button>
    </div>

    <div class="board">
      <div class="eq" id="eqText">‚Äî</div>
      <div class="line"></div>
      <svg id="svg" viewBox="0 0 920 290" aria-label="Rechenstrich-Aufgabe"></svg>

      <div class="actions">
        <button class="btn primary" id="checkBtn" type="button" disabled>√úberpr√ºfen</button>
        <button class="btn secondary" id="clearBtn" type="button">Eingaben l√∂schen</button>
      </div>

      <div class="feedback" id="feedback"></div>
      <div class="hint" id="hintText">Tipp: Zerlege die zweite Zahl in H/Z/E (z.B. 238 ‚Üí 200, 30, 8).</div>
    </div>
  </div>

  <!-- Audio (Repo: ./audio/) -->
  <audio id="snd-correct" src="audio/correct.wav" preload="auto"></audio>
  <audio id="snd-error"   src="audio/error.wav" preload="auto"></audio>
  <audio id="snd-won"     src="audio/gamewon.wav" preload="auto"></audio>

</div>

<script>
  const svg = document.getElementById("svg");
  const eqText = document.getElementById("eqText");
  const feedback = document.getElementById("feedback");
  const checkBtn = document.getElementById("checkBtn");
  const clearBtn = document.getElementById("clearBtn");

  const zrPill = document.getElementById("zrPill");
  const modePill = document.getElementById("modePill");
  const progressPill = document.getElementById("progressPill");
  const hintText = document.getElementById("hintText");

  const sndCorrect = document.getElementById("snd-correct");
  const sndError   = document.getElementById("snd-error");
  const sndWon     = document.getElementById("snd-won");

  let ZR = 100;
  let solvedCorrect = 0; // z√§hlt nur vollst√§ndig richtige Aufgaben
  let task = null;
  let inputs = []; // alle Inputs in der Grafik
  let audioPrimed = false;

  // ---------------- Audio helpers ----------------
  function playSound(a){
    if(!a) return;
    try{
      a.currentTime = 0;
      const p = a.play();
      if(p && typeof p.catch === "function") p.catch(()=>{});
    }catch(e){}
  }
  function primeAudio(){
    if(audioPrimed) return;
    audioPrimed = true;
    try{
      [sndCorrect, sndError, sndWon].forEach(a=>{
        if(!a) return;
        a.volume = 1;
        a.play().then(()=>{ a.pause(); a.currentTime = 0; }).catch(()=>{});
      });
    }catch(e){}
  }

  // ---------------- Start / Navigation ----------------
  function startWithZR(zr){
    ZR = zr;
    solvedCorrect = 0;
    updateHeader();

    document.getElementById("startScreen").classList.add("hidden");
    document.getElementById("taskScreen").classList.remove("hidden");

    primeAudio();
    newTask();
  }

  function backToMenu(){
    document.getElementById("taskScreen").classList.add("hidden");
    document.getElementById("startScreen").classList.remove("hidden");
    feedback.textContent = "";
    feedback.className = "feedback";
  }

  function updateHeader(){
    zrPill.textContent = `ZR ${ZR}`;
    progressPill.textContent = `${solvedCorrect} / 20`;
    hintText.textContent = (ZR === 100)
      ? "Tipp: Zerlege die zweite Zahl in Z/E (z.B. 47 ‚Üí 40, 7)."
      : "Tipp: Zerlege die zweite Zahl in H/Z/E (z.B. 238 ‚Üí 200, 30, 8).";
  }

  // ---------------- Generator ----------------
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function decomposeByZR(n){
    // ZR100: Z/E (keine Hunderter-Spr√ºnge)
    // ZR1000: H/Z/E
    n = Math.abs(n);
    if(ZR === 100){
      const z = Math.floor(n/10)*10;
      const e = n%10;
      return [z,e].filter(x=>x!==0);
    }else{
      const h = Math.floor(n/100)*100;
      const z = Math.floor((n%100)/10)*10;
      const e = n%10;
      return [h,z,e].filter(x=>x!==0);
    }
  }

  function newTask(){
    primeAudio();
    feedback.textContent = "";
    feedback.className = "feedback";
    checkBtn.disabled = true;
    inputs = [];
    while(svg.firstChild) svg.removeChild(svg.firstChild);

    const wantAdd = Math.random() < 0.5;
    const mode = wantAdd ? "add" : "sub";

    // Werte w√§hlen, so dass das Resultat im Zahlenraum bleibt (0..ZR)
    // ZR100: a,b 10..99; ZR1000: a,b 100..999
    let aMin = (ZR === 100) ? 10 : 100;
    let aMax = (ZR === 100) ? 99 : 999;

    let a, b, res;
    for(let tries=0; tries<500; tries++){
      a = randInt(aMin, aMax);
      b = randInt(aMin, aMax);
      res = wantAdd ? (a + b) : (a - b);

      if(wantAdd){
        if(res <= ZR) break;
      }else{
        if(res >= 0) break;
      }
    }

    const parts = decomposeByZR(b);

    // Falls b z.B. 100 bei ZR1000 ‚Üí [100], dann nur 1 Sprung, ist ok.
    task = { mode, a, b, parts };

    modePill.textContent = wantAdd ? "Addition" : "Subtraktion";
    eqText.textContent = `${a} ${wantAdd ? "+" : "‚àí"} ${b} =`;

    updateHeader();
    drawTaskSVG(task);
    updateCheckEnabled();
    focusFirstEmpty();
  }

  // ---------------- SVG helpers ----------------
  function el(name, attrs = {}){
    const n = document.createElementNS("http://www.w3.org/2000/svg", name);
    for(const [k,v] of Object.entries(attrs)) n.setAttribute(k, String(v));
    return n;
  }

  function clearSvg(){
    while(svg.firstChild) svg.removeChild(svg.firstChild);
  }

  // foreignObject input
  function addSvgInput({x,y,w=90,h=44, placeholder="?", id=""}){
    const fo = el("foreignObject", {x, y, width:w, height:h});
    const div = document.createElement("div");
    div.style.width = "100%";
    div.style.height = "100%";
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.justifyContent = "center";

    const inp = document.createElement("input");
    inp.type = "number";
    inp.inputMode = "numeric";
    inp.placeholder = placeholder;
    inp.id = id;

    inp.style.width = "100%";
    inp.style.height = "100%";
    inp.style.boxSizing = "border-box";
    inp.style.border = "2px solid #94a3b8";
    inp.style.borderRadius = "10px";
    inp.style.textAlign = "center";
    inp.style.fontSize = "24px";
    inp.style.fontWeight = "900";
    inp.style.background = "#fff";
    inp.style.color = "#111827";

    inp.addEventListener("input", () => {
      primeAudio();
      // Reset UI
      feedback.textContent = "";
      feedback.className = "feedback";
      inp.style.borderColor = "#94a3b8";
      inp.style.boxShadow = "none";
      updateCheckEnabled();
    });

    inp.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !checkBtn.disabled) checkAll();
    });

    div.appendChild(inp);
    fo.appendChild(div);
    svg.appendChild(fo);
    inputs.push(inp);
    return inp;
  }

  function updateCheckEnabled(){
    const allFilled = inputs.length > 0 && inputs.every(i => i.value.trim() !== "");
    checkBtn.disabled = !allFilled;
  }

  function focusFirstEmpty(){
    const first = inputs.find(i => i.value.trim() === "");
    if(first) first.focus();
  }

  // ---------------- drawTaskSVG (Ratio + volle Breite + Lanes) ----------------
  function drawTaskSVG(task){
    clearSvg();
    inputs = [];

    const W = 920;
    const baseY = 220;
    const leftPad = 90;
    const rightPad = 90;

    // Punkte (Start + Zwischen + End)
    const values = [task.a];
    let cur = task.a;
    for(const p of task.parts){
      cur = task.mode === "add" ? (cur + p) : (cur - p);
      values.push(cur);
    }

    // X-Positionen nach Ratio: 1er=1, 10er=2, 100er=4 (volle Breite)
    const usableW = W - leftPad - rightPad;
    const weights = task.parts.map(p => {
      const ap = Math.abs(p);
      if (ap >= 100) return 4;
      if (ap >= 10) return 2;
      return 1;
    });
    const sumW = weights.reduce((a,b)=>a+b,0) || 1;
    const unit = usableW / sumW;

    const xs = [leftPad];
    for (let i = 0; i < weights.length; i++) xs.push(xs[xs.length - 1] + weights[i] * unit);
    xs[xs.length - 1] = W - rightPad;

    // Grundlinie
    svg.appendChild(el("line", {
      x1:leftPad, y1:baseY, x2:W-rightPad, y2:baseY,
      stroke:"#222", "stroke-width":6, "stroke-linecap":"round", opacity:0.75
    }));

    // Ticks + Startzahl + Inputs
    for(let i=0;i<values.length;i++){
      const x = xs[i];

      svg.appendChild(el("line", {
        x1:x, y1:baseY-16, x2:x, y2:baseY+16,
        stroke:"#222", "stroke-width":6, "stroke-linecap":"round", opacity:0.85
      }));

      if(i === 0){
        const t = el("text", {
          x, y: baseY + 56,
          "text-anchor":"middle",
          "font-size":44,
          "font-weight":600,
          fill:"#111"
        });
        t.textContent = String(values[i]);
        svg.appendChild(t);
      } else if(i === values.length - 1){
        addSvgInput({ x: x-58, y: baseY+24, w:116, h:46, placeholder:"?", id:`p${i}` });

        // Doppelunterstrich (Endergebnis bereits "doppelt unterstrichen")
        svg.appendChild(el("line", { x1:x-78, y1:baseY+78, x2:x+78, y2:baseY+78, stroke:"#111", "stroke-width":3, opacity:0.9 }));
        svg.appendChild(el("line", { x1:x-78, y1:baseY+86, x2:x+78, y2:baseY+86, stroke:"#111", "stroke-width":3, opacity:0.9 }));
      } else {
        addSvgInput({ x: x-58, y: baseY+24, w:116, h:46, placeholder:"?", id:`p${i}` });
      }
    }

    // B√∂gen + Sprung-Inputs (Lanes)
    const laneTopY = [ 90, 125, 155, 175 ];
    const arcTopY  = [ 150, 170, 185, 195 ];

    const arcStroke = "#555";
    const arcWidth = 4;

    for(let i=0;i<task.parts.length;i++){
      const x1 = xs[i];
      const x2 = xs[i+1];
      const mx = (x1 + x2) / 2;

      // didaktisch: fixe H√∂hen, Lesbarkeit > Ma√üstab
      const topY = arcTopY[Math.min(i, arcTopY.length-1)];
      const d = `M ${x1} ${baseY} Q ${mx} ${topY} ${x2} ${baseY}`;
      svg.appendChild(el("path", {
        d, fill:"none", stroke:arcStroke, "stroke-width":arcWidth, "stroke-linecap":"round"
      }));

      const iy = laneTopY[Math.min(i, laneTopY.length-1)];
      addSvgInput({ x: mx-48, y: iy, w:96, h:44, placeholder:"?", id:`jump${i}` });
    }

    // Buttons
    checkBtn.onclick = checkAll;
    clearBtn.onclick = () => {
      primeAudio();
      inputs.forEach(i => {
        i.value = "";
        i.style.borderColor = "#94a3b8";
        i.style.boxShadow = "none";
      });
      feedback.textContent = "";
      feedback.className = "feedback";
      updateCheckEnabled();
      focusFirstEmpty();
    };
  }

  // ---------------- Check ----------------
  function checkAll(){
    primeAudio();

    // Sollwerte berechnen
    const parts = task.parts.slice(); // Spr√ºnge
    const values = [task.a];
    let cur = task.a;
    for(const p of parts){
      cur = (task.mode === "add") ? (cur + p) : (cur - p);
      values.push(cur);
    }

    let wrong = [];

    // Reset borders
    inputs.forEach(inp => {
      inp.style.borderColor = "#94a3b8";
      inp.style.boxShadow = "none";
    });

    // Spr√ºnge pr√ºfen (jump0..)
    for(let i=0;i<parts.length;i++){
      const inp = document.getElementById(`jump${i}`);
      const given = Number(inp.value);
      if(!Number.isFinite(given) || given !== parts[i]) wrong.push(inp);
    }

    // Zwischenwerte + Ergebnis pr√ºfen (p1..)
    for(let i=1;i<values.length;i++){
      const inp = document.getElementById(`p${i}`);
      const given = Number(inp.value);
      if(!Number.isFinite(given) || given !== values[i]) wrong.push(inp);
    }

    if(wrong.length === 0){
      playSound(sndCorrect);
      feedback.textContent = "Alles richtig! ‚úÖ";
      feedback.className = "feedback ok";

      solvedCorrect++;
      updateHeader();

      if(solvedCorrect >= 20){
        // fertig
        setTimeout(() => playSound(sndWon), 200);

        // LearningView
        try{
          if(window.parent && window.parent !== window){
            window.parent.postMessage("AppSolved","*");
          }
        }catch(e){}

        // UI sperren
        checkBtn.disabled = true;
        inputs.forEach(i => i.disabled = true);

        setTimeout(() => {
          feedback.textContent = "20 Aufgaben richtig gel√∂st! üéâ";
          feedback.className = "feedback ok";
        }, 200);

      }else{
        // n√§chste Aufgabe
        setTimeout(newTask, 650);
      }

    }else{
      playSound(sndError);
      feedback.textContent = "Noch nicht ganz ‚Äì rote Felder korrigieren und erneut pr√ºfen.";
      feedback.className = "feedback err";

      wrong.forEach(inp => {
        inp.style.borderColor = "#b91c1c";
        inp.style.boxShadow = "0 0 0 3px rgba(185,28,28,.18)";
      });

      // Fokus erstes falsches Feld
      wrong[0].focus();
    }
  }
</script>
</body>
</html>
