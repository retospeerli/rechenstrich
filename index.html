<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rechenstrich – Eingabe-Aufgabe</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#e9eef3;}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
    .app{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:16px;max-width:980px;width:100%;}
    h1{margin:0 0 8px;text-align:center;font-size:1.35rem;}
    .subtitle{margin:0 0 14px;text-align:center;color:#475569;font-size:.95rem;line-height:1.25rem;}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin-bottom:12px;}
    select,button,input[type="number"]{font-size:1rem;padding:.55rem .7rem;border-radius:10px;border:1px solid #cbd5e1;}
    button{cursor:pointer;border:none;background:#2563eb;color:#fff;font-weight:800;}
    button:hover{background:#1d4ed8;}
    button:disabled{background:#94a3b8;cursor:not-allowed;}
    .board{
      background:#f6f6f6;
      border:3px solid #9aa3ad;
      border-radius:10px;
      padding:12px;
      width:min(920px,100%);
      box-sizing:border-box;
      margin:0 auto;
    }
    .eq{font-size:46px;text-align:center;font-weight:500;letter-spacing:1px;margin:6px 0 6px;}
    .line{height:3px;background:#222;opacity:.65;margin:0 auto 10px;max-width:560px;}
    svg{width:100%;height:auto;display:block;}
    .actions{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:12px;flex-wrap:wrap;}
    .feedback{min-height:1.4rem;text-align:center;font-weight:800;margin-top:8px;}
    .ok{color:#15803d;}
    .err{color:#b91c1c;}
    .small{font-size:.9rem;color:#64748b;text-align:center;margin-top:6px;}
  </style>
</head>
<body>
<div class="app">
  <h1>Rechenstrich als Aufgabe</h1>
  <p class="subtitle">
    Nur die <b>Startzahl</b> ist schon da. <br>
    <b>Alle Zwischenschritte</b>, die <b>Sprünge</b> (200/30/8) und das <b>Endergebnis</b> musst du eintragen. <br>
    Erst wenn alles ausgefüllt ist, kannst du auf <b>Überprüfen</b> klicken.
  </p>

  <div class="row">
    <select id="mode">
      <option value="add">Addition</option>
      <option value="sub">Subtraktion</option>
    </select>
    <input id="a" type="number" value="327" min="0" />
    <span style="font-weight:900;font-size:1.2rem;">mit</span>
    <input id="b" type="number" value="238" min="0" />
    <button id="newTask">Neue Aufgabe</button>
  </div>

  <div class="board">
    <div class="eq" id="eqText">327 + 238 =</div>
    <div class="line"></div>
    <svg id="svg" viewBox="0 0 920 290" aria-label="Rechenstrich-Aufgabe"></svg>

    <div class="actions">
      <button id="checkBtn" disabled>Überprüfen</button>
      <button id="resetBtn" type="button">Eingaben löschen</button>
    </div>
    <div class="feedback" id="feedback"></div>
    <div class="small">Tipp: Zerlege die zweite Zahl in H/Z/E (z.B. 238 → 200, 30, 8).</div>
  </div>
</div>

<script>
  const svg = document.getElementById("svg");
  const eqText = document.getElementById("eqText");
  const feedback = document.getElementById("feedback");
  const checkBtn = document.getElementById("checkBtn");
  const resetBtn = document.getElementById("resetBtn");
  const newTaskBtn = document.getElementById("newTask");

  let task = null;
  let inputs = []; // alle input-Elemente in der Grafik

  document.getElementById("mode").addEventListener("change", buildTaskFromControls);
  document.getElementById("a").addEventListener("change", buildTaskFromControls);
  document.getElementById("b").addEventListener("change", buildTaskFromControls);
  newTaskBtn.addEventListener("click", buildTaskFromControls);

  resetBtn.addEventListener("click", () => {
    inputs.forEach(i => i.value = "");
    feedback.textContent = "";
    feedback.className = "feedback";
    updateCheckEnabled();
    if (inputs[0]) inputs[0].focus();
  });

  checkBtn.addEventListener("click", checkAll);

  // Initial
  buildTaskFromControls();

  function buildTaskFromControls(){
    const mode = document.getElementById("mode").value;   // add/sub
    const a = Number(document.getElementById("a").value);
    const b = Number(document.getElementById("b").value);
    createTask({mode, a, b});
  }

  function decomposeHZE(n){
    const h = Math.floor(n/100)*100;
    const z = Math.floor((n%100)/10)*10;
    const e = n%10;
    return [h,z,e].filter(x => x !== 0);
  }

  function clearSvg(){
    while(svg.firstChild) svg.removeChild(svg.firstChild);
  }

  function el(name, attrs = {}){
    const n = document.createElementNS("http://www.w3.org/2000/svg", name);
    for(const [k,v] of Object.entries(attrs)) n.setAttribute(k, String(v));
    return n;
  }

  // HTML <foreignObject> Input in SVG
  function addSvgInput({x,y,w=90,h=42, placeholder="", id=""}){
    const fo = el("foreignObject", {x, y, width:w, height:h});
    const div = document.createElement("div");
    div.style.width = "100%";
    div.style.height = "100%";
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.justifyContent = "center";

    const inp = document.createElement("input");
    inp.type = "number";
    inp.inputMode = "numeric";
    inp.placeholder = placeholder;
    inp.id = id;
    inp.style.width = "100%";
    inp.style.height = "100%";
    inp.style.boxSizing = "border-box";
    inp.style.border = "2px solid #94a3b8";
    inp.style.borderRadius = "8px";
    inp.style.textAlign = "center";
    inp.style.fontSize = "24px";
    inp.style.fontWeight = "700";
    inp.style.background = "#fff";

    // Events
    inp.addEventListener("input", () => {
      feedback.textContent = "";
      feedback.className = "feedback";
      updateCheckEnabled();
    });
    inp.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !checkBtn.disabled) checkAll();
    });

    div.appendChild(inp);
    fo.appendChild(div);
    svg.appendChild(fo);
    inputs.push(inp);
    return inp;
  }

  function updateCheckEnabled(){
    const allFilled = inputs.every(i => i.value.trim() !== "");
    checkBtn.disabled = !allFilled;
  }

  function createTask({mode, a, b}){
    inputs = [];
    feedback.textContent = "";
    feedback.className = "feedback";
    checkBtn.disabled = true;

    const parts = decomposeHZE(Math.abs(b)); // [200,30,8] (ohne 0)
    const sign = mode === "add" ? "+" : "−";
    const result = mode === "add" ? (a + b) : (a - b);

    eqText.textContent = `${a} ${sign} ${b} =`;

    // Punkte: Start ist bekannt, Rest sind Eingaben
    // Addition: a -> a+p1 -> ... -> result
    // Sub:      a -> a-p1 -> ... -> result
    const points = [a];
    let cur = a;
    for(const p of parts){
      cur = mode === "add" ? (cur + p) : (cur - p);
      points.push(cur);
    }

    task = { mode, a, b, parts, points, result };

    drawTaskSVG(task);
    updateCheckEnabled();

    // Fokus aufs erste Feld
    setTimeout(() => { if(inputs[0]) inputs[0].focus(); }, 0);
  }

  function drawTaskSVG(task){
    clearSvg();

    const W = 920;
    const baseY = 220;
    const leftPad = 80;
    const rightPad = 80;

    // Mappingbereich
    const minV = Math.min(...task.points) - Math.max(10, Math.round(Math.abs(task.b) * 0.08));
    const maxV = Math.max(...task.points) + Math.max(10, Math.round(Math.abs(task.b) * 0.08));
    const xOf = (v) => {
      const t = (v - minV) / (maxV - minV || 1);
      return leftPad + t * (W - leftPad - rightPad);
    };

    // Grundlinie
    svg.appendChild(el("line", { x1:leftPad, y1:baseY, x2:W-rightPad, y2:baseY, stroke:"#222", "stroke-width":6, "stroke-linecap":"round", opacity:0.75 }));

    // Ticks:
    // Startzahl (points[0]) ist als Zahl da (kein Input).
    // Alle anderen Tick-Zahlen sind Inputs.
    for(let i=0;i<task.points.length;i++){
      const v = task.points[i];
      const x = xOf(v);

      svg.appendChild(el("line", { x1:x, y1:baseY-16, x2:x, y2:baseY+16, stroke:"#222", "stroke-width":6, "stroke-linecap":"round", opacity:0.85 }));

      if(i === 0){
        const t = el("text", { x, y: baseY + 56, "text-anchor":"middle", "font-size":44, "font-weight":500, fill:"#111" });
        t.textContent = String(v);
        svg.appendChild(t);
      }else if(i === task.points.length - 1){
        // Endergebnis: Input, aber "doppelt unterstrichen" darunter
        const inp = addSvgInput({ x: x-55, y: baseY+24, w:110, h:46, placeholder:"?", id:`p${i}` });

        // Doppelunterstrich
        svg.appendChild(el("line", { x1:x-70, y1:baseY+78, x2:x+70, y2:baseY+78, stroke:"#111", "stroke-width":3, opacity:0.9 }));
        svg.appendChild(el("line", { x1:x-70, y1:baseY+86, x2:x+70, y2:baseY+86, stroke:"#111", "stroke-width":3, opacity:0.9 }));
      }else{
        addSvgInput({ x: x-55, y: baseY+24, w:110, h:46, placeholder:"?", id:`p${i}` });
      }
    }

    // Bögen + Labels:
    // Alle Sprungwerte (200/30/8) sind ebenfalls Inputs.
    const arcStroke = "#555";
    const arcWidth = 4;

    for(let i=0;i<task.parts.length;i++){
      const p = task.parts[i];
      const from = task.points[i];
      const to   = task.points[i+1];

      const x1 = xOf(from);
      const x2 = xOf(to);
      const dx = Math.abs(x2-x1);
      const arcH = clamp(30 + dx*0.18, 28, 95);
      const topY = baseY - arcH;
      const mx = (x1+x2)/2;

      const d = `M ${x1} ${baseY} Q ${mx} ${topY} ${x2} ${baseY}`;
      svg.appendChild(el("path", { d, fill:"none", stroke:arcStroke, "stroke-width":arcWidth, "stroke-linecap":"round" }));

      // Sprung-Input über dem Bogen (statt Text "200")
      addSvgInput({ x: mx-45, y: topY-58, w:90, h:44, placeholder:"?", id:`jump${i}` });
    }
  }

  function checkAll(){
    // Sammle Werte:
    // - jump0.. : müssen den parts entsprechen
    // - p1..pn : müssen den Zwischenpunkten entsprechen (inkl. Endresultat)
    const errs = [];

    // Jumps prüfen
    for(let i=0;i<task.parts.length;i++){
      const inp = document.getElementById(`jump${i}`);
      const given = Number(inp.value);
      if(given !== task.parts[i]) errs.push(inp);
    }

    // Punkte prüfen (p1..)
    for(let i=1;i<task.points.length;i++){
      const inp = document.getElementById(`p${i}`);
      const given = Number(inp.value);
      if(given !== task.points[i]) errs.push(inp);
    }

    // UI markieren
    inputs.forEach(inp => {
      inp.style.borderColor = "#94a3b8";
      inp.style.boxShadow = "none";
    });

    if(errs.length === 0){
      feedback.textContent = "Alles richtig! ✅";
      feedback.className = "feedback ok";
      // optional: LearningView AppSolved
      try{
        if(window.parent && window.parent !== window){
          window.parent.postMessage("AppSolved","*");
        }
      }catch(e){}
    }else{
      feedback.textContent = "Noch nicht ganz. Prüfe die rot markierten Felder.";
      feedback.className = "feedback err";
      errs.forEach(inp => {
        inp.style.borderColor = "#b91c1c";
        inp.style.boxShadow = "0 0 0 3px rgba(185,28,28,.18)";
      });
      // Fokus erstes falsches Feld
      errs[0].focus();
    }
  }

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
</script>
</body>
</html>
